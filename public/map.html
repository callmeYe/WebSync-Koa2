<!DOCTYPE html>
<html>

<head>
    <title>Example for 2d maps (Leaflet)</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>


    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }
    </style>


</head>

<body>

    <div id='map'></div>

    <script>
        /**
         * 
         * 1. 本页面维护名为MapStatus的状态，监听名为MapStatus和CircleLayer的状态
         * 2. MapStatus状态的内容为{'lat': Number, 'lng': Number, 'zoom': Number}
         * 3. 当MapStatus或者DataTable被其他客户端改变时，本页面会收到一个statusChange事件（以及更新后的状态）
         * 4. 当本页面希望更新MapStatus时，发送一个update事件（以及新状态），所有监听了MapStatus的页面都会收到该更新
         * 
         */

        // 初始化地图插件
        var map = L.map('map').setView([30.54251, 119.9774], 13);
        L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox/streets-v11',
            tileSize: 512,
            zoomOffset: -1
        }).addTo(map);

        // var circleLayer = L.circle([30.54251, 119.9774], {
        //     color: 'red',
        //     fillColor: '#f03',
        //     fillOpacity: 0.5,
        //     radius: 500
        // });

        // 注册地图交互事件
        var interacting = false;
        map.on('mousedown', function () {
            interacting = true;
        });
        map.on('mouseup', function () {
            interacting = false;
        });
        map.on('move', function () {
            if (interacting) updateStatus();
        });
        map.on('zoom', function () {
            updateStatus();
        });

        // 连接WebSocket
        var socket = io.connect('/');

        // WebSocket连接完成后，发送"listen"事件订阅感兴趣的状态表，如"MapStatus"和"DataTable"
        socket.on('connect', function () {
            console.log('socket connect OK!');
            socket.emit('MapStatus', {
                lat: map.getCenter().lat,
                lng: map.getCenter().lng,
                zoom: map.getZoom()
            });
        });

        // 通过监听status事件，持续获取所有已订阅状态的更新
        // socket.on('MapStatus', function (res) {
        //     map.panTo([res.lat, res.lng]);
        //     if (Math.abs(res.zoom - map.getZoom()) > 0.0001) {
        //         map.setView([res.lat, res.lng], res.zoom);
        //     }
        // });
        // socket.on('CircleLayer', function (res) {
        //     if (res.enable == true) {
        //         circleLayer.addTo(map);
        //     } else {
        //         circleLayer.remove();
        //     }
        // });

        // 通过发送"update"事件，更新指定的状态表（即使不订阅该状态表，也可以进行更新）
        function updateStatus() {
            // 发送数据格式为 {status: String, data: Object}
            // 如果status不存在，会自动创建
            // data可以是要更新的全部键值，也可以是部分键值，不存在的键值会自动创建
            socket.emit('MapStatus', {
                lat: map.getCenter().lat,
                lng: map.getCenter().lng,
                zoom: map.getZoom()
            });
        }
    </script>
</body>

</html>